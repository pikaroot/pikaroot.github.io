---
title: "One Page [Code Audit]"
categories: Acs2023
permalink: /ctfs/acs2023/onepage
---
PHP Remote Code Execution.

## ðŸ“ Challenge Description

> Create your own webpage.
>
> `http://192.168.0.52:40081`

Here are the challenge files that we need to audit.

```
$ tree
.
â””â”€â”€ challenge
 Â Â  â”œâ”€â”€ docker-compose.yml
 Â Â  â””â”€â”€ service
 Â Â      â”œâ”€â”€ Dockerfile
 Â Â      â”œâ”€â”€ app
 Â Â      â”‚Â Â  â”œâ”€â”€ application
 Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ controllers
 Â Â      â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ errorController.php
 Â Â      â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ indexController.php
 Â Â      â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ pageController.php
 Â Â      â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ userController.php
 Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ core
 Â Â      â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ bootstrap.php
 Â Â      â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ core.php
 Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ models
 Â Â      â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ fileModel.php
 Â Â      â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ userModel.php
 Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ utils
 Â Â      â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ template.php
 Â Â      â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ util.php
 Â Â      â”‚Â Â  â”‚Â Â  â””â”€â”€ views
 Â Â      â”‚Â Â  â”‚Â Â      â”œâ”€â”€ index.tpl
 Â Â      â”‚Â Â  â”‚Â Â      â”œâ”€â”€ login.tpl
 Â Â      â”‚Â Â  â”‚Â Â      â”œâ”€â”€ page.tpl
 Â Â      â”‚Â Â  â”‚Â Â      â”œâ”€â”€ register.tpl
 Â Â      â”‚Â Â  â”‚Â Â      â””â”€â”€ textarea.tpl
 Â Â      â”‚Â Â  â”œâ”€â”€ index.php
 Â Â      â”‚Â Â  â”œâ”€â”€ public
 Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ sample.css
 Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ sample.html
 Â Â      â”‚Â Â  â”‚Â Â  â””â”€â”€ sample.js
 Â Â      â”‚Â Â  â””â”€â”€ user
 Â Â      â””â”€â”€ flag.txt
```

## ðŸš© Solution

We...

![image](https://github.com/pikaroot/pikaroot.github.io/assets/107750005/37ab43ca-c905-48a9-ad4a-7a0b70892e0a)

After looking through the source code, the possible vulnerability that we found is located in the `application/controllers/pageController.php`.

```php
<?php

namespace Controllers;

class PageController {

    private $file;
    private $userData;
    private $util;
    public function __construct() {

        $this->util = new \utils\util();
        $this->file = new \models\fileModel();
        $this->userData = $_SESSION['userData'];
        if(!isset($this->userData)) $this->util->alertExit("Login Plz");
    }

    public function samplePage() {

        $this->file->copyFile(ROOT . 'public/sample.html', ROOT . 'user/' . $this->userData['uuid'] . '/' . $this->userData['uuid'] . '.html');
        $this->file->copyFile(ROOT . 'public/sample.js', ROOT . 'user/' . $this->userData['uuid'] . '/' . $this->userData['uuid'] . '.js');
        $this->file->copyFile(ROOT . 'public/sample.css', ROOT . 'user/' . $this->userData['uuid'] . '/' . $this->userData['uuid'] . '.css');
        $this->util->alertExit("Create Success");

    }

    public function viewPage() {

        $tpl = new \utils\template(VIEW . 'page.tpl');
        $tpl->render([
            "script" => './user/' . $this->userData['uuid'] . '/' . $this->userData['uuid'] . '.js',
            "css" => './user/' . $this->userData['uuid'] . '/' . $this->userData['uuid'] . '.css',
            "html" => $this->file->getFile(ROOT . 'user/' . $this->userData['uuid'] . '/' . $this->userData['uuid'] . '.html')
        ]);

    }

    public function edit() {

        if(!in_array($_REQUEST['type'], ['html', 'js', 'css'])) $this->util->alertExit("Invalid type");

        if($_SERVER['REQUEST_METHOD'] == 'POST'){

            $this->file->createFile(ROOT . 'user/' . $this->userData['uuid'] . '/' . $this->userData['uuid'] . '.' . $_POST['type'], $_POST['data']);
            $this->util->alertExit("Edit Success");
        }

        $tpl = new \utils\template(VIEW . 'textarea.tpl');
        $tpl->render(["type" => $_GET['type'], "data" => $this->file->getFile(ROOT . 'user/' . $this->userData['uuid'] . '/' . $this->userData['uuid'] . '.' . $_GET['type'])]);

    }

}
```

The...

```php
public function viewPage() {

    $tpl = new \utils\template(VIEW . 'page.tpl');
    $tpl->render([
        "script" => './user/' . $this->userData['uuid'] . '/' . $this->userData['uuid'] . '.js',
        "css" => './user/' . $this->userData['uuid'] . '/' . $this->userData['uuid'] . '.css',
        "html" => $this->file->getFile(ROOT . 'user/' . $this->userData['uuid'] . '/' . $this->userData['uuid'] . '.html')
    ]);

}
```

In...

```php
public function edit() {

    if(!in_array($_REQUEST['type'], ['html', 'js', 'css'])) $this->util->alertExit("Invalid type");

    if($_SERVER['REQUEST_METHOD'] == 'POST'){

        $this->file->createFile(ROOT . 'user/' . $this->userData['uuid'] . '/' . $this->userData['uuid'] . '.' . $_POST['type'], $_POST['data']);
        $this->util->alertExit("Edit Success");
    }

    $tpl = new \utils\template(VIEW . 'textarea.tpl');
    $tpl->render(["type" => $_GET['type'], "data" => $this->file->getFile(ROOT . 'user/' . $this->userData['uuid'] . '/' . $this->userData['uuid'] . '.' . $_GET['type'])]);

}
```

In the...

In...

![image](https://github.com/pikaroot/pikaroot.github.io/assets/107750005/9a3fb65f-5d01-46b8-8e82-93c8d314ccfe)

Based on the concept above, we may get **Local File Inclusion** to **Remote Code Execution**.

After logging in, we first *Create Sample Page* and go to edit *HTML*. I used `<? php echo shell_exec("whoami"); ?>` as my payload to test execution.

![image](https://github.com/pikaroot/pikaroot.github.io/assets/107750005/cbe4ba03-ba7e-40ef-ab14-77a2d0db3f89)

Intercept the traffic with **Burp** when we save the HTML file. We wanted the server to save the file as `.php`.

From here, I added `&type=php` in each line highlighted in the red boxes. Take note that it is necessary to add `;type=html` at the end of the *Cookie* header. We keep it as `html` because the server is checking the *$_COOKIE* too from the *$_REQUEST* method. As long as the server checks the `type=html` exists, it will somehow be granted and ignore other modified fields.

![image](https://github.com/pikaroot/pikaroot.github.io/assets/107750005/5f958f07-2729-4e36-9b8e-e3b2e163d612)

At first, we were concerned about how to leak the user's UUID from the server, and it turns out that it can be found in the network inspector. The `.css` and `.js` files will be loaded every time the *View Page* is clicked. It leaked out the absolute path where the files were stored.

![image](https://github.com/pikaroot/pikaroot.github.io/assets/107750005/dccc3581-ca92-4ce4-81a4-9eca8fd0cf52)

Change the file extension to `.php` and we get the result returned `www-data`. The command inside the `.php` file is successfully executed from the server.

![image](https://github.com/pikaroot/pikaroot.github.io/assets/107750005/94624a88-4fc3-4e06-b813-59aa8f2a4b4c)

Great! Now we can repeat the exploit process once again but modify the PHP payload. I used `../../../../../flag.txt` as it is the file location based on the challenge folder and it works the same when exploited remotely.

```php
<? php echo shell_exec("cat ../../../../../flag.txt"); ?>
```

From here, we can get the flag.

![image](https://github.com/pikaroot/pikaroot.github.io/assets/107750005/44d11f3a-2ba5-416a-b9c4-62c6640a5dd9)

**FLAG**: `ACS{b5932a3742f164d061f67996e41097c9}`
